<style>

    #mapa {
        width: 100%;
        height: 320px;
    } 

</style>

<div class="modal fade" id="nuevoModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">NUEVA CHECADA DE HERRAMIENTA</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form action="?seccion=<?= $seccion; ?>&accion=agregar" id="form1" method="post">
          <fieldset>
            <div class="container">
              <div class="row">
                <div class="col-12">
                  Personal en almacén:
                  <select name="personal" id="personal" required class="form-control">
                    <?php
                    $consulta  = " SELECT * FROM tb_personalenalmacen, tb_almacenes, tb_usuarios
                                   WHERE fk_clave_alm = pk_clave_alm
                                   AND fk_clave_usu = pk_clave_usu 
                                   ORDER BY txt_nombre_usu ASC";
                    $query = $conn->prepare($consulta);
                    $query->execute();
                    while ($registro = $query->fetch()) {
                    ?>
                      <option value="<?= $registro['pk_clave_pea'] ?>"><?= strtoupper($registro['txt_nombre_usu']) . ' - ' . strtoupper($registro['txt_nombre_alm'])?></option>
                    <?php } ?>
                  </select>
                </div>
              </div>
            <div class="col-12 text-center">
                <video id="video" class="capturavideo" playsinline>Video no está disponible.</video>
            </div>
            <div class="col-12 pt-2">
                <img id="photo" width="160px" alt="Tu checada aparecerá en esta sección">
                <input type="hidden" name="fotobase64" id="fotobase64" value="">
            </div>
            <div class="col-12">
                <canvas id="canvas" class="capturafoto"></canvas>
            </div>
            <div class="row">
                <div class="col-12">
                    <p class="text-center">Ubicación actual</p>
                    <div id="mapa"></div>
                    <p><input type="hidden" name="latitud" id="latitud"></p>
                    <p><input type="hidden" name="longitud" id="longitud"></p>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-12 text-center">
                    <button type="submit" id="startbutton" class="btn btn-primary">REGISTRAR</button>
                </div>
            </div>

          </fieldset>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
      </div>
    </div>
  </div>
</div>


<script>
    /* JS comes here */
(function() {
      
  
      var width = 320; // We will scale the photo width to this
      var height = 0; // This will be computed based on the input stream
  
      var streaming = false;
  
      var video = null;
      var canvas = null;
      var photo = null;
      var startbutton = null;
  
      function startup() {
          video = document.getElementById('video');
          canvas = document.getElementById('canvas');
          photo = document.getElementById('photo');
          
          startbutton = document.getElementById('startbutton');
  
          navigator.mediaDevices.getUserMedia({
                  video: true,
                  audio: false
              })
              .then(function(stream) {
                  video.srcObject = stream;
                  video.play();
              })
              .catch(function(err) {
                  console.log("An error occurred: " + err);
              });
  
          video.addEventListener('canplay', function(ev) {
              if (!streaming) {
                  height = video.videoHeight / (video.videoWidth / width);
  
                  if (isNaN(height)) {
                      height = width / (4 / 3);
                  } 
                  video.setAttribute('width', width-50);
                  video.setAttribute('height', 280);
                  canvas.setAttribute('width', width);
                  canvas.setAttribute('height', height);
                  streaming = true;
              }
          }, false);
  
          startbutton.addEventListener('click', function(ev) {
              takepicture();
              //ev.preventDefault();
          }, false);
  
          clearphoto();
      }
  
  
      function clearphoto() {
          var context = canvas.getContext('2d');
          context.fillStyle = "#AAA";
          context.fillRect(0, 0, canvas.width, canvas.height);
          var data = canvas.toDataURL('image/png');
          photo.setAttribute('src', data);            
      }
  
      function takepicture() {
          var context = canvas.getContext('2d');
          if (width && height) {
              canvas.width = width;
              canvas.height = height;
              context.drawImage(video, 0, 0, width, height);
  
              var data = canvas.toDataURL('image/jpeg', 0.8);
              photo.setAttribute('src', data);
              fotobase64.value = data;
  
          } else {
              clearphoto();
          }
      }
  
      window.addEventListener('load', startup, false);
  })();

</script>


<script>

    function iniciaMapa() {

        var coordenadas = {
            lat: 21.142217316901, lng: -101.68952619340665
        }

        var map = new google.maps.Map(
            document.getElementById('mapa'),
            {
                center: coordenadas,
                zoom: 15
            }
        );

        var latitud = document.getElementById("latitud");
        var longitud = document.getElementById("longitud");

        latitud.value = coordenadas.lat;
        longitud.value = coordenadas.lng;

        if(navigator.geolocation){
            navigator.geolocation.getCurrentPosition( position => {
                
                var coordenadas = { 
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                latitud.value = coordenadas.lat;
                longitud.value = coordenadas.lng;

                var marcador = new google.maps.Marker({ position: coordenadas, map: map });
                map.setCenter(coordenadas);


            });
        }

    }

</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC1t0wlh0LziR3jb7nPSPN_PbzwTnujGzU&callback=iniciaMapa" async defer></script>
